apiVersion: nais.io/v1alpha1
kind: Application
metadata:
  annotations:
    nais.io/read-only-file-system: "false"
  name: umami
  namespace: team-researchops
  labels:
    team: team-researchops
spec:
  image: {{ image }}
  valkey:
    - instance: umami
      access: readwrite
  env:
    - name: "DATABASE_TYPE"
      value: "postgresql"
    - name: "FORCE_SSL"
      value: "1"
    - name: "DISABLE_TELEMETRY"
      value: "1"
    - name: "LOG_QUERY"
      value: "0"
    - name: "DEBUG"
      value: "prisma:*:info"
    - name: "PRISMA_CLI_CACHE_DIR"
      value: "/tmp/.cache"
    - name: "DATABASE_URL"
      value: "postgresql://$(NAIS_DATABASE_UMAMI_UMAMI_USERNAME):$(NAIS_DATABASE_UMAMI_UMAMI_PASSWORD)@$(NAIS_DATABASE_UMAMI_UMAMI_HOST):$(NAIS_DATABASE_UMAMI_UMAMI_PORT)/umami?sslmode=no-verify&sslrootcert=$(NAIS_DATABASE_UMAMI_UMAMI_SSLROOTCERT)&sslcert=$(NAIS_DATABASE_UMAMI_UMAMI_SSLCERT)&sslkey=$(NAIS_DATABASE_UMAMI_UMAMI_SSLKEY)"
    - name: "REDIS_URL"
      value: "rediss://$(VALKEY_USERNAME_UMAMI):$(VALKEY_PASSWORD_UMAMI)@$(VALKEY_HOST_UMAMI):$(VALKEY_PORT_UMAMI)"
    - name: "DEBUG"
      value: "umami:*"

  accessPolicy:
    inbound:
      rules:
        - application: reops-umami-consumer
  gcp:
    sqlInstances:
      - type: POSTGRES_18
        tier: db-f1-micro
        flags:
          - name: cloudsql.logical_decoding
            value: "on"
        databases:
          - name: umami
        diskAutoresize: true
  ingresses:
    - "https://umami.ansatt.dev.nav.no"
  resources:
    requests:
      cpu: "600m"
      memory: "512Mi"
  liveness:
    path: "/login"
    port: 3000
  readiness:
    path: "/login"
    port: 3000
  replicas:
    cpuThresholdPercentage: 50
    max: 2
    min: 1
  port: 3000
